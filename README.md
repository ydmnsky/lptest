# Ansible Playbook для настройки инфраструктуры

## О РЕПОЗИТОРИИ

Это Тестовое задание на позицию linux-администратора. Все пояснения даны для стороны работодателя. Если вы случайно набрели на эту репу и у вас есть вопросы, пишите: y@dmnsky.ru
Все ip-адреса, пароли, явки в файлах ныне недействительны, служат плэйсхолдерами.

## ПОСТАНОВКА ЗАДАЧИ

### Общая задача

Необходимо написать Ansible playbook, который выполнит следующие задачи:

1. Поднять 2 инстанса PostgreSQL и настроить master-slave репликацию.
2. Инициализировать базу данных и создать таблицы:
   - **User**: UserID, FullName, Login, HashPassword, Email, PhoneNumber
   - **Permission**: PermissionID, Name
   - **UserPermission**: UserPermissionID, UserID, PermissionID
3. Создать 2 пользователей в PostgreSQL:
   - Администратор с полными правами
   - Пользователь с доступом только к созданной базе данных
4. Добавить в таблицы несколько тестовых записей.
5. Написать web-сервер на Python, который будет по HTTP отправлять HTML с содержимым таблиц базы данных.
6. Развернуть Vault. Учетные данные для доступа к базе данных из web-сервера на Python хранятся в нём.
7. Настроить Nginx для балансировки нагрузки на два контейнера с web-сервером:
   - Страница со статистикой доступна только для определенных IP.
8. Playbook должен настраивать iptables на Docker хосте с политиками DROP и доступом по SSH только с определенных IP.

### Технологии

- Ansible
- iptables
- Docker
- Nginx
- Python (Flask, Django, HVAC, ...)
- Vault
- PostgreSQL

### Требования к системе

- Все скрипты должны исполняться на Ubuntu 18.04.
- Всё должно запускаться в Docker-контейнерах, за исключением Ansible.

## КАК ЗАПУСКАТЬ

### Среда, на которой тестировалось:

- Ansible 2.14.9

### Команды для установки зависимостей:

```bash
ansible-galaxy collection install community.postgresql
ansible-galaxy collection install community.docker
```
Перед запуском измените `inventory.txt`, добавив в него целевые машины.

## ЧТО ВЫПОЛНЕНО

- Создаются 2 инстанса PostgreSQL в режиме Master-Slave.
- Добавляются пользователи: админ с полными правами и юзер без прав на создание баз.
- Добавляются тестовые записи в таблицы.
- Написан веб-сервер на Flask, который склеивает и отдаёт информацию из базы данных.
- Поднимается Vault, сервер получает credentials из него.
- Поднимается Nginx для балансировки нагрузки между двумя инстансами веб-серверов.

## ЧТО НЕ УСПЕЛ

- Репликация не работает из-за ошибки в конфигурации. Нашёл подробную статью, как это исправить, но нужно ещё немного времени.
- Страница со статистикой и ограничение доступа к ней не реализованы.
- Настройки iptables пока закомментированы, так как в таком виде они блокируют доступ к порту 80.

## ИНСТРУКЦИИ ПО ЗАПУСКУ

Для запуска playbook следуйте следующим шагам:

1. Убедитесь, что у вас установлен Ansible версии 2.14.9 или выше и зависимости.
2. Установите необходимые зависимости Ansible, используя команды, указанные выше.
3. Отредактируйте файл `inventory.txt`, указав адреса целевых машин.
4. Запустите playbook командой `ansible-playbook playbook.yml`.
